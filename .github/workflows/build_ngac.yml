on: [pull_request]
name: Build tog-ngac-crosscpp for all targets

jobs:
  build_linux:
    name: Build NGAC for Linux
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Install SWI Prolog
        run: sudo apt-get install swi-prolog
      - name: Build NGAC
        run: |
          git pull
          echo "Cloning the TOG-NGAC repo"
          git clone https://github.com/tog-rtd/tog-ngac-crosscpp
          echo "Building the NGAC server"
          cd tog-ngac-crosscpp
          swipl -v -o ngac -g ngac -c ngac.pl
          swipl -v -o ngac_server -g ngac_server -c ngac.pl
          echo "Building the CME server"
          swipl -v -o cme -g cme -c cme_sim.pl
          echo "Building the PEP server"
          cd PEP-RAP
          swipl -v -o pep_server -g pep_server -c pep.pl
          echo "SUCCESS: NGAC server built"
          echo "Coppying the NGAC server, into src/NGAC/executables/{os}"
          mkdir -p ../../src/NGAC/executables/linux
          cp ../ngac ../ngac_server ../cme ./pep_server ../../src/NGAC/executables/linux
      - name: Commit and push NGAC server
        run: |
          echo "Committing and pushing the NGAC server"
          git config --global user.email "NgacBuilder[bot]@users.noreply.github.com"
          git config --global user.name "NgacBuilder[bot]"
          git add .
          git commit -m "NGAC server built for Linux"
          git push
  build_macos:
    name: Build NGAC for MacOS
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v2
      - name: Install SWI Prolog
        run: brew install swi-prolog
      - name: Build NGAC
        run: |
          git pull
          echo "Cloning the TOG-NGAC repo"
          git clone https://github.com/tog-rtd/tog-ngac-crosscpp
          echo "Building the NGAC server"
          cd tog-ngac-crosscpp
          swipl -v -o ngac -g ngac -c ngac.pl
          swipl -v -o ngac_server -g ngac_server -c ngac.pl
          echo "Building the CME server"
          swipl -v -o cme -g cme -c cme_sim.pl
          echo "Building the PEP server"
          cd PEP-RAP
          swipl -v -o pep_server -g pep_server -c pep.pl
          echo "SUCCESS: NGAC server built"
          echo "Coppying the NGAC server, into src/NGAC/executables/{os}"
          mkdir -p ../../src/NGAC/executables/macos
          cp ../ngac ../ngac_server ../cme ./pep_server ../../src/NGAC/executables/macos
      - name: Commit and push NGAC server
        run: |
          echo "Committing and pushing the NGAC server"
          git config --global user.email "NgacBuilder[bot]@users.noreply.github.com"
          git config --global user.name "NgacBuilder[bot]"
          git add .
          git commit -m "NGAC server built for MacOS"
          git push
